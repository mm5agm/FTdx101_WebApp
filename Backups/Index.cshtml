@page
@model IndexModel
@{
    ViewData["Title"] = "FT-dx101 Series Control";
}

<link rel="stylesheet" href="~/css/site.css" />

<div class="container-fluid">
    <div class="row g-3">
        <!-- Receiver A Panel -->
        <div class="col-lg-6 col-12">
            <div class="card border-primary h-100 receiver-card">
                <div class="card-header bg-primary text-white">
                    <h3>
                        <span id="receiverAHeading">Receiver A</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div>
                        <label>Frequency:</label>
                        <span id="freqA" class="fw-bold frequency-display digit-display"></span>
                    </div>
                    <div class="mb-3">
                        <label>Bands:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var band in new[] { "160m", "80m", "60m", "40m", "30m", "20m", "17m", "15m", "12m", "10m", "6m", "4m" })
                            {
                                <button class="btn btn-outline-primary btn-sm" onclick="setBand('A','@band')">@band</button>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Mode:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var mode in new[] { "LSB", "USB", "CW", "FM", "AM", "DATA-USB", "RTTY-USB", "C4FM" })
                            {
                                <button class="btn btn-outline-primary btn-sm" onclick="setMode('A','@mode')">@mode</button>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Antenna:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var ant in new[] { "1", "2", "3" })
                            {
                                <button class="btn btn-outline-primary btn-sm" onclick="setAntenna('A','@ant')">ANT @ant</button>
                            }
                        </div>
                    </div>
                    <div>
                        <label>S-Meter:</label>
                        <span id="sMeterValueA">S0</span>
                        <span id="sMeterRawA" class="text-muted" style="margin-left:0.5em; font-size:1rem;"></span>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" id="sMeterBarA" style="width:0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Receiver B Panel -->
        <div class="col-lg-6 col-12">
            <div class="card border-success h-100 receiver-card">
                <div class="card-header bg-success text-white">
                    <h3>
                        <span id="receiverBHeading">Receiver B</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div>
                        <label>Frequency:</label>
                        <span id="freqB" class="fw-bold frequency-display digit-display"></span>
                    </div>
                    <div class="mb-3">
                        <label>Bands:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var band in new[] { "160m", "80m", "60m", "40m", "30m", "20m", "17m", "15m", "12m", "10m", "6m", "4m" })
                            {
                                <button class="btn btn-outline-success btn-sm" onclick="setBand('B','@band')">@band</button>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Mode:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var mode in new[] { "LSB", "USB", "CW", "FM", "AM", "DATA-USB", "RTTY-USB", "C4FM" })
                            {
                                <button class="btn btn-outline-success btn-sm" onclick="setMode('B','@mode')">@mode</button>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Antenna:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var ant in new[] { "1", "2", "3" })
                            {
                                <button class="btn btn-outline-success btn-sm" onclick="setAntenna('B','@ant')">ANT @ant</button>
                            }
                        </div>
                    </div>
                    <div>
                        <label>S-Meter:</label>
                        <span id="sMeterValueB">S0</span>
                        <span id="sMeterRawB" class="text-muted" style="margin-left:0.5em; font-size:1rem;"></span>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" id="sMeterBarB" style="width:0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // --- Frequency Digit Display and Interaction ---
        function renderFrequencyDigits(freq) {
            if (!freq || freq < 1000) return '<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>.<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>.<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>';
            let s = freq.toString().padStart(9, "0");
            let html = "";
            for (let i = 0; i < 9; i++) {
                if (i === 3 || i === 6) html += '<span class="digit">.</span>';
                html += `<span class="digit" tabindex="0">${s[i]}</span>`;
            }
            return html;
        }

        function updateFrequencyDisplay(receiver, freqHz) {
            const display = document.getElementById('freq' + receiver);
            display.innerHTML = renderFrequencyDigits(freqHz);
        }

        function initializeDigitInteraction(receiver) {
            const display = document.getElementById('freq' + receiver);
            display.addEventListener('click', function (e) {
                if (!e.target.classList.contains('digit') || e.target.textContent === '.') return;
                display.querySelectorAll('.digit').forEach(d => d.classList.remove('selected'));
                e.target.classList.add('selected');
            });
            display.addEventListener('wheel', function (e) {
                const selected = display.querySelector('.digit.selected');
                if (!selected || selected.textContent === '.') return;
                const digits = Array.from(display.querySelectorAll('.digit')).filter(d => d.textContent !== '.');
                const idx = digits.indexOf(selected);
                if (idx === -1) return;
                let freqStr = digits.map(d => d.textContent).join('');
                let freq = parseInt(freqStr);
                let pos = 8 - idx;
                let delta = Math.pow(10, pos) * (e.deltaY < 0 ? 1 : -1);
                let newFreq = Math.max(30000, Math.min(75000000, freq + delta));
                updateFrequencyDisplay(receiver, newFreq);
                // Keep selection
                const newDigits = display.querySelectorAll('.digit');
                let digitIdx = 0;
                for (let i = 0; i < newDigits.length; i++) {
                    if (newDigits[i].textContent !== '.') {
                        if (digitIdx === idx) newDigits[i].classList.add('selected');
                        digitIdx++;
                    }
                }
                // Debounce send
                clearTimeout(display._debounceTimer);
                display._debounceTimer = setTimeout(() => setFrequency(receiver, newFreq), 200);
                e.preventDefault();
            }, { passive: false });
        }

        async function setFrequency(receiver, freqHz) {
            await fetch(`/api/cat/frequency/${receiver.toLowerCase()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ frequencyHz: freqHz })
            });
        }

        async function setBand(receiver, band) {
            await fetch(`/api/cat/band/${receiver.toLowerCase()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ band })
            });
            setTimeout(fetchRadioStatus, 500);
        }

        async function setMode(receiver, mode) {
            await fetch(`/api/cat/mode/${receiver.toLowerCase()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode })
            });
            setTimeout(fetchRadioStatus, 500);
        }

        async function setAntenna(receiver, antenna) {
            await fetch(`/api/cat/antenna/${receiver.toLowerCase()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ antenna })
            });
            setTimeout(fetchRadioStatus, 500);
        }

        // --- S-Meter Mapping with Interpolation ---
        function sMeterLabel(val) {
            const points = [
                { label: "S0", value: 0 },
                { label: "S1", value: 4 },
                { label: "S3", value: 30 },
                { label: "S5", value: 65 },
                { label: "S7", value: 95 },
                { label: "S9", value: 130 },
                { label: "S9+20", value: 171 },
                { label: "S9+40", value: 212 },
                { label: "S9+60", value: 255 }
            ];
            if (val <= points[0].value) return points[0].label;
            for (let i = 1; i < points.length; i++) {
                if (val <= points[i].value) {
                    const prev = points[i - 1];
                    const next = points[i];
                    const frac = (val - prev.value) / (next.value - prev.value);
                    if (val === next.value) return next.label;
                    if (next.label.startsWith("S9+")) {
                        const plus = parseInt(next.label.replace("S9+", ""));
                        const prevPlus = prev.label.startsWith("S9+") ? parseInt(prev.label.replace("S9+", "")) : 0;
                        const interp = Math.round(prevPlus + frac * (plus - prevPlus));
                        return "S9+" + interp;
                    } else {
                        const prevNum = parseInt(prev.label.replace("S", ""));
                        const nextNum = parseInt(next.label.replace("S", ""));
                        const interp = Math.round(prevNum + frac * (nextNum - prevNum));
                        return "S" + interp;
                    }
                }
            }
            return "S9+60";
        }

        function updateSMeter(receiver, value) {
            const percentage = (value / 255) * 100;
            document.getElementById('sMeterBar' + receiver).style.width = percentage + '%';
            document.getElementById('sMeterBar' + receiver).setAttribute('aria-valuenow', value);
            document.getElementById('sMeterValue' + receiver).textContent = sMeterLabel(value);
            document.getElementById('sMeterRaw' + receiver).textContent = `[${value}]`;
        }

        async function fetchRadioStatus() {
            const response = await fetch('/api/cat/status');
            if (!response.ok) return;
            const data = await response.json();
            updateFrequencyDisplay('A', data.vfoA.frequency);
            updateFrequencyDisplay('B', data.vfoB.frequency);
            updateSMeter('A', data.vfoA.sMeter);
            updateSMeter('B', data.vfoB.sMeter);
            initializeDigitInteraction('A');
            initializeDigitInteraction('B');
            // ... update other UI as needed ...
        }

        setInterval(fetchRadioStatus, 2000);
        fetchRadioStatus();
    </script>
}