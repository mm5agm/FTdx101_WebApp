name: Build and Release Installer

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to upload to (e.g. v0.5.1)'
        required: true

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install NSIS
        run: choco install nsis --yes
        shell: pwsh

      - name: Publish app
        run: |
          dotnet publish FTdx101_WebApp.csproj `
            --configuration Release `
            --runtime win-x86 `
            --self-contained false `
            --output publish
        shell: pwsh

      - name: List publish output
        run: |
          Write-Host "=== publish\ ==="
          if (Test-Path publish) { Get-ChildItem publish -Name } else { Write-Host "publish dir missing!" }
          Write-Host "=== root ==="
          Get-ChildItem -Name
        shell: pwsh

      - name: Build NSIS installer
        run: |
          $makensis = (Get-Command makensis.exe -ErrorAction SilentlyContinue)?.Source
          if (-not $makensis) { $makensis = "C:\Program Files (x86)\NSIS\makensis.exe" }
          if (!(Test-Path $makensis)) { Write-Error "makensis.exe not found at $makensis"; exit 1 }
          Write-Host "Using NSIS at: $makensis"
          $outFile = "$env:GITHUB_WORKSPACE\FTdx101_WebApp_Setup.exe"
          Write-Host "Output path: $outFile"
          & $makensis "/DOUTFILE=$outFile" installer.nsi
          if ($LASTEXITCODE -ne 0) { Write-Error "NSIS failed (exit $LASTEXITCODE)"; exit 1 }
          Write-Host "=== Files in workspace root after NSIS ==="
          Get-ChildItem -Filter "*.exe" | Select-Object Name, Length
        shell: pwsh

      - name: Verify installer was created
        run: |
          Write-Host "Working dir: $PWD"
          Write-Host "GITHUB_WORKSPACE: $env:GITHUB_WORKSPACE"
          Write-Host "=== Searching entire workspace for *.exe ==="
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object FullName, Length
          $outFile = "$env:GITHUB_WORKSPACE\FTdx101_WebApp_Setup.exe"
          if (!(Test-Path $outFile)) {
            Write-Error "FTdx101_WebApp_Setup.exe was NOT found at: $outFile"
            exit 1
          }
          Write-Host "Found: $outFile ($('{0:N0}' -f (Get-Item $outFile).Length) bytes)"
        shell: pwsh

      - name: Upload installer to release
        run: gh release upload "${{ inputs.tag || github.ref_name }}" "$env:GITHUB_WORKSPACE\FTdx101_WebApp_Setup.exe" --clobber
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
