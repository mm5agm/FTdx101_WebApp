name: Build and Release Installer

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to upload to (e.g. v0.5.1)'
        required: true

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install NSIS
        run: choco install nsis --yes
        shell: pwsh

      - name: Publish app
        run: |
          dotnet publish FTdx101_WebApp.csproj `
            --configuration Release `
            --runtime win-x86 `
            --self-contained false `
            --output publish
        shell: pwsh

      - name: List publish output
        run: |
          Write-Host "=== publish\ ==="
          if (Test-Path publish) { Get-ChildItem publish -Name } else { Write-Host "publish dir missing!" }
          Write-Host "=== root ==="
          Get-ChildItem -Name
        shell: pwsh

      - name: Build NSIS installer
        run: |
          $makensis = (Get-Command makensis.exe -ErrorAction SilentlyContinue)?.Source
          if (-not $makensis) { $makensis = "C:\Program Files (x86)\NSIS\makensis.exe" }
          if (!(Test-Path $makensis)) { Write-Error "makensis.exe not found at $makensis"; exit 1 }
          Write-Host "Using NSIS at: $makensis"
          & $makensis installer.nsi
          if ($LASTEXITCODE -ne 0) { Write-Error "NSIS failed (exit $LASTEXITCODE)"; exit 1 }
          # Find whatever Setup exe NSIS produced and normalise the name
          $found = Get-ChildItem -Filter "*Setup*.exe" | Select-Object -First 1
          if (!$found) { Write-Error "No *Setup*.exe found after NSIS ran"; exit 1 }
          Write-Host "NSIS produced: $($found.FullName)"
          if ($found.Name -ne "FTdx101_WebApp_Setup.exe") {
            Rename-Item $found.FullName "FTdx101_WebApp_Setup.exe"
            Write-Host "Renamed to FTdx101_WebApp_Setup.exe"
          }
        shell: pwsh

      - name: Verify installer was created
        run: |
          if (!(Test-Path "FTdx101_WebApp_Setup.exe")) {
            Write-Error "FTdx101_WebApp_Setup.exe not found after build"
            exit 1
          }
          Write-Host "OK: $('{0:N0}' -f (Get-Item FTdx101_WebApp_Setup.exe).Length) bytes"
        shell: pwsh

      - name: Upload installer to release
        run: gh release upload "${{ inputs.tag || github.ref_name }}" FTdx101_WebApp_Setup.exe --clobber
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
