@page
@model IndexModel
@{
    ViewData["Title"] = "FT-dx101 Series Control";
}

<link rel="stylesheet" href="~/css/site.css" />

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5">
                <i class="bi bi-broadcast-pin"></i> FT-dx101 Series Web Control
            </h1>
            <p class="lead text-muted">Supports FT-dx101MP (dual receiver) and FT-dx101D (single receiver)</p>
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> <strong>Tip:</strong> Click on any frequency digit, then use mouse wheel (desktop) or swipe up/down (mobile) to tune!
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- Receiver A Panel (Left Side) -->
        <div class="col-lg-6 col-12">
            <div class="card border-primary h-100 receiver-card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-reception-4"></i> Receiver A (Main VFO)
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Frequency Display -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Frequency</label>
                        <div class="input-group input-group-lg">
                            <div id="freqA" class="digit-display text-center fw-bold flex-grow-1">
                                <span class="digit hidden">-</span><span class="digit">-</span><span class="digit">-</span>.<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>.<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>
                            </div>
                            <span class="input-group-text">Hz</span>
                        </div>
                    </div>
                    <!-- Band Buttons -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Band</label>
                        <div class="d-flex flex-nowrap gap-2 band-row-scroll">
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','160m')">160m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','80m')">80m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','60m')">60m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','40m')">40m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','30m')">30m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','20m')">20m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','17m')">17m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','15m')">15m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','12m')">12m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','10m')">10m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','6m')">6m</button>
                            <button class="btn btn-outline-primary band-btn" onclick="setBand('A','4m')">4m</button>
                        </div>
                    </div>
                    <!-- Antenna Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Antenna</label>
                        <div class="row g-1">
                            <div class="col-4">
                                <button class="btn btn-outline-primary antenna-btn w-100" onclick="setAntenna('A', '1')" data-receiver="A" data-antenna="1">ANT 1</button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-primary antenna-btn w-100" onclick="setAntenna('A', '2')" data-receiver="A" data-antenna="2">ANT 2</button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-primary antenna-btn w-100" onclick="setAntenna('A', '3')" data-receiver="A" data-antenna="3">ANT 3</button>
                            </div>
                        </div>
                    </div>
                    <!-- Mode Display -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Mode</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text"><i class="bi bi-gear"></i></span>
                            <input type="text" class="form-control text-center fw-bold" id="modeA" value="---" readonly>
                        </div>
                        <!-- Mode Selection Buttons -->
                        <div class="row g-1">
                            <div class="col-3">
                                <button class="btn btn-outline-primary mode-btn w-100" onclick="setMode('A', 'LSB')" data-receiver="A" data-mode="LSB">LSB</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-primary mode-btn w-100" onclick="setMode('A', 'USB')" data-receiver="A" data-mode="USB">USB</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-primary mode-btn w-100" onclick="setMode('A', 'CW')" data-receiver="A" data-mode="CW">CW</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-primary mode-btn w-100" onclick="setMode('A', 'FM')" data-receiver="A" data-mode="FM">FM</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-primary mode-btn w-100" onclick="setMode('A', 'AM')" data-receiver="A" data-mode="AM">AM</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-primary mode-btn w-100" onclick="setMode('A', 'DATA-USB')" data-receiver="A" data-mode="DATA-USB">DATA</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-primary mode-btn w-100" onclick="setMode('A', 'RTTY-USB')" data-receiver="A" data-mode="RTTY-USB">RTTY</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-primary mode-btn w-100" onclick="setMode('A', 'C4FM')" data-receiver="A" data-mode="C4FM">C4FM</button>
                            </div>
                        </div>
                    </div>
                    <!-- S-Meter -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">S-Meter: <span id="sMeterValueA">S0</span></label>
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar bg-success progress-bar-striped" id="sMeterBarA"
                                 role="progressbar" style="width: 0%;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="255">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small><i class="bi bi-wifi" id="statusIconA"></i> <span id="connectionStatusA">Connecting...</span> | Last Update: <span id="lastUpdateA">--:--:--</span></small>
                </div>
            </div>
        </div>

        <!-- Receiver B Panel (Right Side) -->
        <div class="col-lg-6 col-12">
            <div class="card border-success h-100 receiver-card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-reception-4"></i> Receiver B (Sub VFO)
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Frequency Display -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Frequency</label>
                        <div class="input-group input-group-lg">
                            <div id="freqB" class="digit-display text-center fw-bold flex-grow-1">
                                <span class="digit hidden">-</span><span class="digit">-</span><span class="digit">-</span>.<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>.<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>
                            </div>
                            <span class="input-group-text">Hz</span>
                        </div>
                    </div>
                    <!-- Band Buttons -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Band</label>
                        <div class="d-flex flex-nowrap gap-2 band-row-scroll">
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','160m')">160m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','80m')">80m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','60m')">60m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','40m')">40m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','30m')">30m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','20m')">20m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','17m')">17m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','15m')">15m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','12m')">12m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','10m')">10m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','6m')">6m</button>
                            <button class="btn btn-outline-success band-btn" onclick="setBand('B','4m')">4m</button>
                        </div>
                    </div>
                    <!-- Antenna Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Antenna</label>
                        <div class="row g-1">
                            <div class="col-4">
                                <button class="btn btn-outline-success antenna-btn w-100" onclick="setAntenna('B', '1')" data-receiver="B" data-antenna="1">ANT 1</button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-success antenna-btn w-100" onclick="setAntenna('B', '2')" data-receiver="B" data-antenna="2">ANT 2</button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-success antenna-btn w-100" onclick="setAntenna('B', '3')" data-receiver="B" data-antenna="3">ANT 3</button>
                            </div>
                        </div>
                    </div>
                    <!-- Mode Display -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Mode</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text"><i class="bi bi-gear"></i></span>
                            <input type="text" class="form-control text-center fw-bold" id="modeB" value="---" readonly>
                        </div>
                        <!-- Mode Selection Buttons -->
                        <div class="row g-1">
                            <div class="col-3">
                                <button class="btn btn-outline-success mode-btn w-100" onclick="setMode('B', 'LSB')" data-receiver="B" data-mode="LSB">LSB</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-success mode-btn w-100" onclick="setMode('B', 'USB')" data-receiver="B" data-mode="USB">USB</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-success mode-btn w-100" onclick="setMode('B', 'CW')" data-receiver="B" data-mode="CW">CW</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-success mode-btn w-100" onclick="setMode('B', 'FM')" data-receiver="B" data-mode="FM">FM</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-success mode-btn w-100" onclick="setMode('B', 'AM')" data-receiver="B" data-mode="AM">AM</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-success mode-btn w-100" onclick="setMode('B', 'DATA-USB')" data-receiver="B" data-mode="DATA-USB">DATA</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-success mode-btn w-100" onclick="setMode('B', 'RTTY-USB')" data-receiver="B" data-mode="RTTY-USB">RTTY</button>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-outline-success mode-btn w-100" onclick="setMode('B', 'C4FM')" data-receiver="B" data-mode="C4FM">C4FM</button>
                            </div>
                        </div>
                    </div>
                    <!-- S-Meter -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">S-Meter: <span id="sMeterValueB">S0</span></label>
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar bg-success progress-bar-striped" id="sMeterBarB"
                                 role="progressbar" style="width: 0%;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="255">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small><i class="bi bi-wifi" id="statusIconB"></i> <span id="connectionStatusB">Connecting...</span> | Last Update: <span id="lastUpdateB">--:--:--</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center" role="alert" id="systemStatus">
                <i class="bi bi-info-circle-fill me-2"></i>
                <div>
                    <strong>System Status:</strong> <span id="statusText">Connecting to radio...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Control -->
    <div class="row mt-2">
        <div class="col-12 text-center">
            <button id="connectionBtn" class="btn btn-danger" onclick="toggleConnection()">
                <i class="bi bi-wifi" id="connectionBtnIcon"></i> <span id="connectionBtnText">Disconnect Radio</span>
            </button>
            <div id="connectionHelpText" class="form-text text-muted mt-2">
                <i class="bi bi-info-circle"></i> Use this button to properly release the COM port before closing the application
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Band selection
        async function setBand(receiver, band) {
            try {
                const response = await fetch(`/api/cat/band/${receiver.toLowerCase()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ band })
                });
                if (response.ok) {
                    // Optionally update UI or highlight button
                    console.log(`✓ Band ${band} set for receiver ${receiver}`);
                }
            } catch (error) {
                console.error('Error setting band:', error);
            }
        }

        // Antenna selection
        async function setAntenna(receiver, antenna) {
            try {
                const response = await fetch(`/api/cat/antenna/${receiver.toLowerCase()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ antenna })
                });
                if (response.ok) {
                    // Optionally update UI or highlight button
                    console.log(`✓ Antenna ${antenna} set for receiver ${receiver}`);
                }
            } catch (error) {
                console.error('Error setting antenna:', error);
            }
        }

        // Mode selection
        async function setMode(receiver, mode) {
            try {
                const response = await fetch(`/api/cat/mode/${receiver.toLowerCase()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                if (response.ok) {
                    document.getElementById('mode' + receiver).value = mode;
                    console.log(`✓ Mode ${mode} set for receiver ${receiver}`);
                }
            } catch (error) {
                console.error('Error setting mode:', error);
            }
        }

        // Connection control (toggle)
        async function toggleConnection() {
            const btn = document.getElementById('connectionBtn');
            const btnText = document.getElementById('connectionBtnText');
            const btnIcon = document.getElementById('connectionBtnIcon');
            const helpText = document.getElementById('connectionHelpText');
            if (btn.classList.contains('btn-danger')) {
                if (!confirm('Disconnect from the radio?')) return;
                btn.disabled = true;
                btnText.textContent = 'Disconnecting...';
                try {
                    const response = await fetch('/api/cat/disconnect', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                    if (response.ok) {
                        btn.className = 'btn btn-success';
                        btnIcon.className = 'bi bi-check-circle';
                        btnText.textContent = 'Reconnect Radio';
                        helpText.innerHTML = '<i class="bi bi-info-circle"></i> Click to reconnect';
                    }
                } catch (error) {
                    console.error('Error disconnecting:', error);
                } finally {
                    btn.disabled = false;
                }
            } else {
                btn.disabled = true;
                btnText.textContent = 'Reconnecting...';
                btnIcon.className = 'bi bi-arrow-clockwise';
                try {
                    const response = await fetch('/api/cat/status');
                    if (response.ok) {
                        btn.className = 'btn btn-danger';
                        btnIcon.className = 'bi bi-wifi';
                        btnText.textContent = 'Disconnect Radio';
                        helpText.innerHTML = '<i class="bi bi-info-circle"></i> Release COM port before closing';
                    }
                } catch (error) {
                    console.error('Error reconnecting:', error);
                } finally {
                    btn.disabled = false;
                }
            }
        }
    </script>
}