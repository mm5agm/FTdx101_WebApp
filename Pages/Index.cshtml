@page
@model FTdx101_WebApp.Pages.IndexModel
@{
    ViewData["Title"] = "FT-dx101 Series Control";
    var allModes = new[] {
        "LSB", "USB", "CW-U", "CW-L", "FM", "FM-N", "AM", "AM-N", "RTTY-L", "RTTY-U",
        "DATA-L", "DATA-U", "DATA-FM", "DATA-FM-N", "PSK"
    };
}

<!-- Cache-busted CSS reference -->
<link rel="stylesheet" href="~/css/site.css?v=20260222b" />

<!-- Overlay for initialization status -->
<div id="initOverlay" class="init-overlay">
    <div class="init-message">
        <span id="initStatusText">Initializing radio, please wait...</span>
        <div class="spinner-border text-primary" role="status"></div>
    </div>
</div>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-auto">
            <button id="wsjtxBtn" class="btn btn-secondary btn-lg"
                    onclick="launchWsjtx()" title="Launch WSJT-X">
                WSJT-X
                <span id="wsjtxTxBadge" class="badge bg-danger ms-1" style="display:none;">TX</span>
            </button>
        </div>
    </div>
    <div class="row g-3 flex-wrap">
        <!-- Receiver A Panel -->
        <div class="col-lg-6 col-12">
            <div class="card border-primary h-100 receiver-card">
                <div class="card-header bg-primary text-white">
                    <h3>
                        <span id="receiverAHeading">Receiver A</span>
                    </h3>
                </div>
                <div class="card-body">
                    <!-- S-Meter at top -->
                    <div class="mb-3">
                        <label>S-Meter:</label>
                        <div class="analog-meter-container">
                            <canvas id="sMeterCanvasA"></canvas>
                        </div>
                        <div class="text-center mt-1">
                            <span id="sMeterValueA" class="badge bg-secondary">S0</span>
                            <span id="sMeterRawA" class="text-muted ms-2 small">[0]</span>
                        </div>
                        <div class="text-center mt-2">
                            <span id="txIndicatorA" class="badge bg-secondary" style="display:none; font-size: 1.2em; padding: 8px 16px;">
                                <strong>TX</strong>
                            </span>
                        </div>
                    </div>

                    <!-- Controls below -->
                    <div>
                        <label>Frequency:</label>
                        <div class="d-flex align-items-center">
                            <span id="freqA" class="fw-bold frequency-display digit-display"></span>
                            <div id="freqA-controls" class="ms-2" style="display:none;">
                                <button id="freqA-up" class="btn btn-secondary btn-sm">▲</button>
                                <button id="freqA-down" class="btn btn-secondary btn-sm">▼</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Bands (A):</label>
                        @await Html.PartialAsync("_BandButtonsPartial", Tuple.Create("unused", "A", Model.SelectedBandA))
                    </div>
                    <!-- POWER CONTROL FOR RECEIVER A -->
                    <div class="mb-3">
                        <label>Power: <span id="powerValueA" class="fw-bold">0W</span></label>
                        <input type="range" class="form-range power-slider"
                               id="powerSliderA"
                               min="5"
                               max="200"
                               step="5"
                               value="100"
                               oninput="window.radioControl.updatePowerDisplay('A', this.value)"
                               onchange="window.radioControl.setPower('A', this.value)">
                        <div class="d-flex justify-content-between small text-muted">
                            <span>5W</span>
                            <span>100W</span>
                            <span id="powerMaxLabelA">@Model.RadioState.MaxPower W</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Mode:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var mode in new[] { "LSB", "USB", "CW-U", "CW-L", "FM", "FM-N", "AM", "AM-N", "RTTY-L", "RTTY-U", "DATA-L", "DATA-U", "DATA-FM", "DATA-FM-N", "PSK" })
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input"
                                           type="radio"
                                           name="modeA"
                                           id="modeA_@mode"
                                           value="@mode"
                                           @(Model.RadioState.ModeA == mode ? "checked" : "")
                                           onchange="window.radioControl.setMode('A','@mode')">
                                    <label class="form-check-label" for="modeA_@mode">@mode</label>
                                </div>
                            }
                        </div>
                        <span id="modeDisplayA"></span>
                    </div>
                    <div class="mb-3">
                        <label>Antenna:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var ant in new[] { "1", "2", "3" })
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input"
                                           type="radio"
                                           name="antennaA"
                                           id="antennaA_@ant"
                                           value="@ant"
                                           @(Model.RadioState.AntennaA == ant ? "checked" : "")
                                           onchange="window.radioControl.setAntenna('A','@ant')">
                                    <label class="form-check-label" for="antennaA_@ant">ANT @ant</label>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Receiver B Panel -->
        <div class="col-lg-6 col-12">
            <div class="card border-success h-100 receiver-card">
                <div class="card-header bg-success text-white">
                    <h3>
                        <span id="receiverBHeading">Receiver B</span>
                    </h3>
                </div>
                <div class="card-body">
                    <!-- S-Meter at top -->
                    <div class="mb-3">
                        <label>S-Meter:</label>
                        <div class="analog-meter-container">
                            <canvas id="sMeterCanvasB"></canvas>
                        </div>
                        <div class="text-center mt-1">
                            <span id="sMeterValueB" class="badge bg-secondary">S0</span>
                            <span id="sMeterRawB" class="text-muted ms-2 small">[0]</span>
                        </div>
                        <div class="text-center mt-2">
                            <span id="txIndicatorB" class="badge bg-secondary" style="display:none; font-size: 1.2em; padding: 8px 16px;">
                                <strong>TX</strong>
                            </span>
                        </div>
                    </div>

                    <!-- Controls below -->
                    <div>
                        <label>Frequency:</label>
                        <div class="d-flex align-items-center">
                            <span id="freqB" class="fw-bold frequency-display digit-display"></span>
                            <div id="freqB-controls" class="ms-2" style="display:none;">
                                <button id="freqB-up" class="btn btn-secondary btn-sm">▲</button>
                                <button id="freqB-down" class="btn btn-secondary btn-sm">▼</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Bands (B):</label>
                        @await Html.PartialAsync("_BandButtonsPartial", Tuple.Create("unused", "B", Model.SelectedBandB))
                    </div>
                    <!-- POWER CONTROL FOR RECEIVER B -->
                    <div class="mb-3">
                        <label>Mode:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var mode in allModes)
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input"
                                           type="radio"
                                           name="modeB"
                                           id="modeB_@mode"
                                           value="@mode"
                                           @(Model.RadioState.ModeB == mode ? "checked" : "")
                                           onchange="window.radioControl.setMode('B','@mode')">
                                    <label class="form-check-label" for="modeB_@mode">@mode</label>
                                </div>
                            }
                        </div>
                        <span id="modeDisplayB"></span>
                    </div>
                    <div class="mb-3">
                        <label>Antenna:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var ant in new[] { "1", "2", "3" })
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input"
                                           type="radio"
                                           name="antennaB"
                                           id="antennaB_@ant"
                                           value="@ant"
                                           @(Model.RadioState.AntennaB == ant ? "checked" : "")
                                           onchange="window.radioControl.setAntenna('B','@ant')">
                                    <label class="form-check-label" for="antennaB_@ant">ANT @ant</label>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Power and SWR Meters Row -->
    <div class="row g-3 flex-wrap mt-3">
        <!-- Power Meter -->
        <div class="col-lg-6 col-12">
            <div class="card border-warning h-100">
                <div class="card-header bg-warning text-dark">
                    <h4>Power Output</h4>
                </div>
                <div class="card-body">
                    <div class="analog-meter-container">
                        <canvas id="powerMeterCanvas"></canvas>
                    </div>
                    <div class="text-center mt-1">
                        <span id="powerMeterValue" class="badge bg-warning text-dark">0W</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SWR Meter -->
        <div class="col-lg-6 col-12">
            <div class="card border-danger h-100">
                <div class="card-header bg-danger text-white">
                    <h4>SWR</h4>
                </div>
                <div class="card-body">
                    <div class="analog-meter-container">
                        <canvas id="swrMeterCanvas"></canvas>
                    </div>
                    <div class="text-center mt-1">
                        <span id="swrMeterValue" class="badge bg-danger">1.0:1</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <!-- Cache-busted JS reference, placed BEFORE your inline script if you use window.radioControl, etc. -->
    <script src="~/js/site.js?v=20260222d"></script>
    <script>
        async function launchWsjtx() {
            try {
                const response = await fetch('/api/wsjtx/launch', { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.alreadyRunning) {
                        console.log('WSJT-X is already running, brought window to front');
                        // Optional: show a brief message to the user
                        const btn = document.getElementById('wsjtxBtn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = 'WSJT-X Already Running';
                        setTimeout(() => { btn.innerHTML = originalText; }, 2000);
                    }
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to launch WSJT-X');
                }
            } catch (e) {
                alert('Error launching WSJT-X: ' + e.message);
            }
        }

        async function updateWsjtxStatus() {
            try {
                const response = await fetch('/api/wsjtx/status');
                if (response.ok) {
                    const data = await response.json();
                    const btn = document.getElementById('wsjtxBtn');
                    const txBadge = document.getElementById('wsjtxTxBadge');

                    // Green = UDP connected (WSJT-X talking to us)
                    // Yellow = process running but no UDP yet
                    // Grey = not running
                    btn.classList.remove('btn-secondary', 'btn-success', 'btn-warning');
                    if (data.connected) {
                        btn.classList.add('btn-success');
                        btn.title = 'WSJT-X connected' + (data.mode ? ' \u2014 ' + data.mode : '');
                    } else if (data.running) {
                        btn.classList.add('btn-warning');
                        btn.title = 'WSJT-X running \u2014 waiting for UDP data';
                    } else {
                        btn.classList.add('btn-secondary');
                        btn.title = 'Launch WSJT-X';
                    }

                    // Red TX badge when transmitting
                    if (txBadge) {
                        txBadge.style.display = data.transmitting ? 'inline' : 'none';
                    }
                }
            } catch (e) { /* ignore */ }
        }

        updateWsjtxStatus();
        setInterval(updateWsjtxStatus, 5000);
    </script>
}