@page
@model IndexModel
@{
    ViewData["Title"] = "FT-dx101 Series Control";
}

<link rel="stylesheet" href="~/css/site.css" />

<div class="container-fluid">
    <div class="row g-3 flex-wrap">
        <!-- Receiver A Panel -->
        <div class="col-lg-6 col-12">
            <div class="card border-primary h-100 receiver-card">
                <div class="card-header bg-primary text-white">
                    <h3>
                        <span id="receiverAHeading">Receiver A</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div>
                        <label>Frequency:</label>
                        <span id="freqA" class="fw-bold frequency-display digit-display"></span>
                    </div>
                    <div class="mb-3">
                        <label>Bands:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var band in new[] { "160m", "80m", "60m", "40m", "30m", "20m", "17m", "15m", "12m", "10m", "6m", "4m" })
                            {
                                <button class="btn btn-outline-primary btn-sm band-btn"
                                        data-receiver="A" data-value="@band"
                                        onclick="setBand('A','@band')">
                                    @band
                                </button>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Mode:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var mode in new[] { "LSB", "USB", "CW", "FM", "AM", "DATA-USB", "RTTY-USB", "C4FM" })
                            {
                                <button class="btn btn-outline-primary btn-sm mode-btn"
                                        data-receiver="A" data-value="@mode"
                                        onclick="setMode('A','@mode')">
                                    @mode
                                </button>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Antenna:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var ant in new[] { "1", "2", "3" })
                            {
                                <button class="btn btn-outline-primary btn-sm antenna-btn"
                                        data-receiver="A" data-value="@ant"
                                        onclick="setAntenna('A','@ant')">
                                    ANT @ant
                                </button>
                            }
                        </div>
                    </div>
                    <div>
                        <label>S-Meter:</label>
                        <span id="sMeterValueA">S0</span>
                        <span id="sMeterRawA" class="text-muted" style="margin-left:0.5em; font-size:1rem;"></span>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" id="sMeterBarA" style="width:0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Receiver B Panel -->
        <div class="col-lg-6 col-12">
            <div class="card border-success h-100 receiver-card">
                <div class="card-header bg-success text-white">
                    <h3>
                        <span id="receiverBHeading">Receiver B</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div>
                        <label>Frequency:</label>
                        <span id="freqB" class="fw-bold frequency-display digit-display"></span>
                    </div>
                    <div class="mb-3">
                        <label>Bands:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var band in new[] { "160m", "80m", "60m", "40m", "30m", "20m", "17m", "15m", "12m", "10m", "6m", "4m" })
                            {
                                <button class="btn btn-outline-success btn-sm band-btn"
                                        data-receiver="B" data-value="@band"
                                        onclick="setBand('B','@band')">
                                    @band
                                </button>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Mode:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var mode in new[] { "LSB", "USB", "CW", "FM", "AM", "DATA-USB", "RTTY-USB", "C4FM" })
                            {
                                <button class="btn btn-outline-success btn-sm mode-btn"
                                        data-receiver="B" data-value="@mode"
                                        onclick="setMode('B','@mode')">
                                    @mode
                                </button>
                            }
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Antenna:</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var ant in new[] { "1", "2", "3" })
                            {
                                <button class="btn btn-outline-success btn-sm antenna-btn"
                                        data-receiver="B" data-value="@ant"
                                        onclick="setAntenna('B','@ant')">
                                    ANT @ant
                                </button>
                            }
                        </div>
                    </div>
                    <div>
                        <label>S-Meter:</label>
                        <span id="sMeterValueB">S0</span>
                        <span id="sMeterRawB" class="text-muted" style="margin-left:0.5em; font-size:1rem;"></span>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" id="sMeterBarB" style="width:0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        let editing = { A: false, B: false };
        let localFreq = { A: null, B: null };
        let selectedIdx = { A: null, B: null };
        let lastSentFreq = { A: null, B: null };
        let lastBackendFreq = { A: null, B: null };
        let lastBand = { A: null, B: null };
        let lastMode = { A: null, B: null };
        let lastAntenna = { A: null, B: null };

        function renderFrequencyDigits(freq, selIdx) {
            if (!freq || freq < 1000) return '<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>.<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>.<span class="digit">-</span><span class="digit">-</span><span class="digit">-</span>';
            let s = freq.toString().padStart(9, "0");
            let html = "";
            let digitIdx = 0;
            for (let i = 0; i < 9; i++) {
                if (i === 3 || i === 6) {
                    html += '<span class="digit">.</span>';
                }
                let selected = (selIdx === digitIdx) ? " selected" : "";
                html += `<span class="digit${selected}" tabindex="0">${s[i]}</span>`;
                digitIdx++;
            }
            return html;
        }

        function updateFrequencyDisplay(receiver, freqHz) {
            const display = document.getElementById('freq' + receiver);
            let selIdx = selectedIdx[receiver];
            let freqToShow = (editing[receiver] && localFreq[receiver] !== null) ? localFreq[receiver] : freqHz;
            display.innerHTML = renderFrequencyDigits(freqToShow, selIdx);
        }

        function highlightButtons(receiver, band, mode, antenna) {
            document.querySelectorAll(`.band-btn[data-receiver="${receiver}"]`).forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-value') === band);
            });
            document.querySelectorAll(`.mode-btn[data-receiver="${receiver}"]`).forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-value') === mode);
            });
            document.querySelectorAll(`.antenna-btn[data-receiver="${receiver}"]`).forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-value') === antenna);
            });
        }

        function initializeDigitInteraction(receiver) {
            const display = document.getElementById('freq' + receiver);
            if (display._initialized) return;
            display._initialized = true;

            display.addEventListener('click', function (e) {
                if (!e.target.classList.contains('digit') || e.target.textContent === '.') return;
                let digits = Array.from(display.querySelectorAll('.digit')).filter(d => d.textContent !== '.');
                digits.forEach(d => d.classList.remove('selected'));
                selectedIdx[receiver] = digits.indexOf(e.target);
                if (selectedIdx[receiver] !== -1) {
                    digits[selectedIdx[receiver]].classList.add('selected');
                    editing[receiver] = true;
                    localFreq[receiver] = parseInt(digits.map(d => d.textContent).join(''));
                }
            });

            display.addEventListener('wheel', function (e) {
                let digits = Array.from(display.querySelectorAll('.digit')).filter(d => d.textContent !== '.');
                let idx = selectedIdx[receiver];
                if (idx === null || !digits[idx]) return;
                let freqArr = digits.map(d => parseInt(d.textContent));
                let carry = e.deltaY < 0 ? 1 : -1;
                let i = idx;
                while (carry !== 0 && i >= 0 && i < freqArr.length) {
                    let newVal = freqArr[i] + carry;
                    if (newVal > 9) {
                        freqArr[i] = 0;
                        carry = 1;
                        i--;
                    } else if (newVal < 0) {
                        freqArr[i] = 9;
                        carry = -1;
                        i--;
                    } else {
                        freqArr[i] = newVal;
                        carry = 0;
                    }
                }
                let newFreq = parseInt(freqArr.join(''));
                newFreq = Math.max(30000, Math.min(75000000, newFreq));
                localFreq[receiver] = newFreq;
                updateFrequencyDisplay(receiver, newFreq);
                // Keep selection
                let newDigits = Array.from(display.querySelectorAll('.digit')).filter(d => d.textContent !== '.');
                newDigits.forEach(d => d.classList.remove('selected'));
                if (selectedIdx[receiver] !== null && newDigits[selectedIdx[receiver]]) {
                    newDigits[selectedIdx[receiver]].classList.add('selected');
                }
                // Debounce send
                clearTimeout(display._debounceTimer);
                display._debounceTimer = setTimeout(() => {
                    setFrequency(receiver, newFreq);
                    lastSentFreq[receiver] = newFreq;
                    localFreq[receiver] = null;
                }, 600);
                e.preventDefault();
            }, { passive: false });

            document.addEventListener('click', function (e) {
                if (!display.contains(e.target)) {
                    selectedIdx[receiver] = null;
                    editing[receiver] = false;
                    localFreq[receiver] = null;
                    updateFrequencyDisplay(receiver, lastBackendFreq[receiver]);
                }
            });
        }

        async function setFrequency(receiver, freqHz) {
            await fetch(`/api/cat/frequency/${receiver.toLowerCase()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ frequencyHz: freqHz })
            });
            // Update UI immediately
            updateFrequencyDisplay(receiver, freqHz);
        }

        async function setBand(receiver, band) {
            highlightButtons(receiver, band, lastMode[receiver], lastAntenna[receiver]);
            lastBand[receiver] = band;
            await fetch(`/api/cat/band/${receiver.toLowerCase()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ band })
            });
            setTimeout(fetchRadioStatus, 500);
        }

        async function setMode(receiver, mode) {
            highlightButtons(receiver, lastBand[receiver], mode, lastAntenna[receiver]);
            lastMode[receiver] = mode;
            await fetch(`/api/cat/mode/${receiver.toLowerCase()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode })
            });
            setTimeout(fetchRadioStatus, 500);
        }

        async function setAntenna(receiver, antenna) {
            highlightButtons(receiver, lastBand[receiver], lastMode[receiver], antenna);
            lastAntenna[receiver] = antenna;
            await fetch(`/api/cat/antenna/${receiver.toLowerCase()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ antenna })
            });
            setTimeout(fetchRadioStatus, 500);
        }

        function sMeterLabel(val) {
            const points = [
                { label: "S0", value: 0 },
                { label: "S1", value: 4 },
                { label: "S3", value: 30 },
                { label: "S5", value: 65 },
                { label: "S7", value: 95 },
                { label: "S9", value: 130 },
                { label: "S9+20", value: 171 },
                { label: "S9+40", value: 212 },
                { label: "S9+60", value: 255 }
            ];
            if (val <= points[0].value) return points[0].label;
            for (let i = 1; i < points.length; i++) {
                if (val <= points[i].value) {
                    const prev = points[i - 1];
                    const next = points[i];
                    const frac = (val - prev.value) / (next.value - prev.value);
                    if (val === next.value) return next.label;
                    if (next.label.startsWith("S9+")) {
                        const plus = parseInt(next.label.replace("S9+", ""));
                        const prevPlus = prev.label.startsWith("S9+") ? parseInt(prev.label.replace("S9+", "")) : 0;
                        const interp = Math.round(prevPlus + frac * (plus - prevPlus));
                        return "S9+" + interp;
                    } else {
                        const prevNum = parseInt(prev.label.replace("S", ""));
                        const nextNum = parseInt(next.label.replace("S", ""));
                        const interp = Math.round(prevNum + frac * (nextNum - prevNum));
                        return "S" + interp;
                    }
                }
            }
            return "S9+60";
        }

        function updateSMeter(receiver, value) {
            const percentage = (value / 255) * 100;
            document.getElementById('sMeterBar' + receiver).style.width = percentage + '%';
            document.getElementById('sMeterBar' + receiver).setAttribute('aria-valuenow', value);
            document.getElementById('sMeterValue' + receiver).textContent = sMeterLabel(value);
            document.getElementById('sMeterRaw' + receiver).textContent = `[${value}]`;
        }

        async function fetchRadioStatus() {
            const response = await fetch('/api/cat/status');
            if (!response.ok) return;
            const data = await response.json();
            lastBackendFreq.A = data.vfoA.frequency;
            lastBackendFreq.B = data.vfoB.frequency;

            lastBand.A = data.vfoA.band;
            lastBand.B = data.vfoB.band;
            lastMode.A = data.vfoA.mode;
            lastMode.B = data.vfoB.mode;
            lastAntenna.A = data.vfoA.antenna;
            lastAntenna.B = data.vfoB.antenna;

            // Only exit editing if backend confirms the last sent value AND the user is not in the middle of editing
            if (editing.A && lastSentFreq.A !== null && localFreq.A === null && data.vfoA.frequency === lastSentFreq.A) {
                editing.A = false;
                selectedIdx.A = null;
            }
            if (editing.B && lastSentFreq.B !== null && localFreq.B === null && data.vfoB.frequency === lastSentFreq.B) {
                editing.B = false;
                selectedIdx.B = null;
            }

            if (!editing.A) updateFrequencyDisplay('A', data.vfoA.frequency);
            else updateFrequencyDisplay('A', localFreq.A);

            if (!editing.B) updateFrequencyDisplay('B', data.vfoB.frequency);
            else updateFrequencyDisplay('B', localFreq.B);

            updateSMeter('A', data.vfoA.sMeter);
            updateSMeter('B', data.vfoB.sMeter);
            highlightButtons('A', data.vfoA.band, data.vfoA.mode, data.vfoA.antenna);
            highlightButtons('B', data.vfoB.band, data.vfoB.mode, data.vfoB.antenna);
        }

        initializeDigitInteraction('A');
        initializeDigitInteraction('B');
        setInterval(fetchRadioStatus, 2000);
        fetchRadioStatus();
    </script>
}