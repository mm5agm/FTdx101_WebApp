@page
@model IndexModel
@{
    ViewData["Title"] = "FT-dx101 Series Control";
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5">
                <i class="bi bi-broadcast-pin"></i> FT-dx101 Series Web Control
            </h1>
            <p class="lead text-muted">Supports FT-dx101MP (dual receiver) and FT-dx101D (single receiver)</p>
        </div>
    </div>

    <div class="row g-3">
        <!-- Receiver A Panel (Left Side) -->
        <div class="col-lg-6">
            <div class="card border-primary h-100">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-reception-4"></i> Receiver A (Main VFO)
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Frequency Display -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Frequency</label>
                        <div class="input-group input-group-lg mb-2">
                            <input type="text" class="form-control text-center fw-bold"
                                   id="freqA" value="---.---.---" readonly style="font-size: 2rem; letter-spacing: 0.1em;">
                            <span class="input-group-text">Hz</span>
                        </div>
                        <!-- Frequency Controls -->
                        <div class="row g-2">
                            <div class="col-4">
                                <button class="btn btn-outline-primary w-100" onclick="adjustFrequency('A', 1000000)">
                                    <i class="bi bi-plus-lg"></i> 1 MHz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-primary w-100" onclick="adjustFrequency('A', 10000)">
                                    <i class="bi bi-plus-lg"></i> 10 kHz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-primary w-100" onclick="adjustFrequency('A', 100)">
                                    <i class="bi bi-plus-lg"></i> 100 Hz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-primary w-100" onclick="adjustFrequency('A', -1000000)">
                                    <i class="bi bi-dash-lg"></i> 1 MHz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-primary w-100" onclick="adjustFrequency('A', -10000)">
                                    <i class="bi bi-dash-lg"></i> 10 kHz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-primary w-100" onclick="adjustFrequency('A', -100)">
                                    <i class="bi bi-dash-lg"></i> 100 Hz
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Mode Display -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Mode</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-gear"></i></span>
                            <input type="text" class="form-control text-center fw-bold" id="modeA" value="---" readonly>
                        </div>
                    </div>

                    <!-- S-Meter -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">S-Meter: <span id="sMeterValueA">S0</span></label>
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar bg-success progress-bar-striped" id="sMeterBarA"
                                 role="progressbar" style="width: 0%;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="255">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small><i class="bi bi-wifi" id="statusIconA"></i> <span id="connectionStatusA">Connecting...</span> | Last Update: <span id="lastUpdateA">--:--:--</span></small>
                </div>
            </div>
        </div>

        <!-- Receiver B Panel (Right Side) -->
        <div class="col-lg-6">
            <div class="card border-success h-100">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-reception-4"></i> Receiver B (Sub VFO)
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Frequency Display -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Frequency</label>
                        <div class="input-group input-group-lg mb-2">
                            <input type="text" class="form-control text-center fw-bold"
                                   id="freqB" value="---.---.---" readonly style="font-size: 2rem; letter-spacing: 0.1em;">
                            <span class="input-group-text">Hz</span>
                        </div>
                        <!-- Frequency Controls -->
                        <div class="row g-2">
                            <div class="col-4">
                                <button class="btn btn-outline-success w-100" onclick="adjustFrequency('B', 1000000)">
                                    <i class="bi bi-plus-lg"></i> 1 MHz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-success w-100" onclick="adjustFrequency('B', 10000)">
                                    <i class="bi bi-plus-lg"></i> 10 kHz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-success w-100" onclick="adjustFrequency('B', 100)">
                                    <i class="bi bi-plus-lg"></i> 100 Hz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-success w-100" onclick="adjustFrequency('B', -1000000)">
                                    <i class="bi bi-dash-lg"></i> 1 MHz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-success w-100" onclick="adjustFrequency('B', -10000)">
                                    <i class="bi bi-dash-lg"></i> 10 kHz
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-success w-100" onclick="adjustFrequency('B', -100)">
                                    <i class="bi bi-dash-lg"></i> 100 Hz
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Mode Display -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Mode</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-gear"></i></span>
                            <input type="text" class="form-control text-center fw-bold" id="modeB" value="---" readonly>
                        </div>
                    </div>

                    <!-- S-Meter -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">S-Meter: <span id="sMeterValueB">S0</span></label>
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar bg-info progress-bar-striped" id="sMeterBarB"
                                 role="progressbar" style="width: 0%;"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="255">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small><i class="bi bi-wifi" id="statusIconB"></i> <span id="connectionStatusB">Connecting...</span> | Last Update: <span id="lastUpdateB">--:--:--</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center" role="alert" id="systemStatus">
                <i class="bi bi-info-circle-fill me-2"></i>
                <div>
                    <strong>System Status:</strong> <span id="statusText">Connecting to radio...</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Current frequencies in Hz (from radio)
        let freqA = 0;
        let freqB = 0;

        // Request throttling
        let isFetching = false;
        let isAdjusting = false;
        let consecutiveErrors = 0;
        let pollInterval = 1000; // Start with 1 second polling

        // Fetch radio status from API
        async function fetchRadioStatus() {
            // Skip if already fetching or adjusting frequency
            if (isFetching || isAdjusting) {
                return;
            }

            isFetching = true;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

                const response = await fetch('/api/cat/status', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                updateDisplay(data);

                // Reset error counter on success
                consecutiveErrors = 0;
                pollInterval = 1000; // Back to 1 second

            } catch (error) {
                consecutiveErrors++;
                console.error('Error fetching radio status:', error);

                // Slow down polling on repeated errors
                if (consecutiveErrors > 3) {
                    pollInterval = 3000; // Slow to 3 seconds after errors
                }

                updateConnectionStatus(false, `Connection error (${consecutiveErrors} errors)`);
            } finally {
                isFetching = false;
            }
        }

        // Update display with radio data
        function updateDisplay(data) {
            if (!data.isConnected) {
                updateConnectionStatus(false, data.message || 'Not connected');
                return;
            }

            // Update VFO-A
            freqA = data.vfoA.frequency;
            updateFrequencyDisplay('A', freqA);
            document.getElementById('modeA').value = data.vfoA.mode;
            updateSMeter('A', data.vfoA.sMeter);

            // Update VFO-B
            freqB = data.vfoB.frequency;
            updateFrequencyDisplay('B', freqB);
            document.getElementById('modeB').value = data.vfoB.mode;
            updateSMeter('B', data.vfoB.sMeter);

            // Update timestamps
            const now = new Date().toLocaleTimeString();
            document.getElementById('lastUpdateA').textContent = now;
            document.getElementById('lastUpdateB').textContent = now;

            // Update connection status
            updateConnectionStatus(true, 'Connected to FT-dx101');
        }

        // Update frequency display
        function updateFrequencyDisplay(receiver, freqHz) {
            if (freqHz === 0) {
                document.getElementById('freq' + receiver).value = '---.---.---';
                return;
            }

            // Format frequency with thousands separators
            const formatted = freqHz.toString().padStart(9, '0');
            const display = formatted.substring(0, 3) + '.' +
                          formatted.substring(3, 6) + '.' +
                          formatted.substring(6, 9);
            document.getElementById('freq' + receiver).value = display;
        }

        // Update S-Meter display
        function updateSMeter(receiver, value) {
            // S-Meter scale: 0-255
            const percentage = (value / 255) * 100;

            let displayText = 'S0';
            if (value >= 150) {
                displayText = 'S9+' + Math.round((value - 120) / 3) + 'dB';
            } else if (value >= 120) {
                displayText = 'S9';
            } else if (value > 0) {
                displayText = 'S' + Math.floor(value / 13.3);
            }

            document.getElementById('sMeterBar' + receiver).style.width = percentage + '%';
            document.getElementById('sMeterBar' + receiver).setAttribute('aria-valuenow', value);
            document.getElementById('sMeterValue' + receiver).textContent = displayText;
        }

        // Update connection status
        function updateConnectionStatus(connected, message) {
            const statusText = document.getElementById('statusText');
            const systemStatus = document.getElementById('systemStatus');

            if (connected) {
                statusText.textContent = message;
                systemStatus.className = 'alert alert-success d-flex align-items-center';
                document.getElementById('connectionStatusA').textContent = 'Connected';
                document.getElementById('connectionStatusB').textContent = 'Connected';
            } else {
                statusText.textContent = message;
                systemStatus.className = 'alert alert-warning d-flex align-items-center';
                document.getElementById('connectionStatusA').textContent = 'Error';
                document.getElementById('connectionStatusB').textContent = 'Error';
            }
        }

        // Adjust frequency function
        async function adjustFrequency(receiver, change) {
            if (isAdjusting) {
                console.log('Already adjusting frequency, skipping...');
                return;
            }

            const currentFreq = receiver === 'A' ? freqA : freqB;
            const newFreq = Math.max(30000, Math.min(75000000, currentFreq + change));

            isAdjusting = true;
            try {
                const endpoint = receiver === 'A' ? '/api/cat/frequency/a' : '/api/cat/frequency/b';

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frequencyHz: newFreq }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    // Update local value immediately for responsiveness
                    if (receiver === 'A') {
                        freqA = newFreq;
                    } else {
                        freqB = newFreq;
                    }
                    updateFrequencyDisplay(receiver, newFreq);

                    // Wait a bit before resuming polling
                    await new Promise(resolve => setTimeout(resolve, 200));
                } else {
                    console.error('Failed to set frequency:', await response.text());
                }
            } catch (error) {
                console.error('Error setting frequency:', error);
            } finally {
                isAdjusting = false;
            }
        }

        // Dynamic polling with adjustable interval
        function startPolling() {
            fetchRadioStatus(); // Initial fetch

            setInterval(() => {
                fetchRadioStatus();
            }, () => pollInterval); // Use dynamic interval
        }

        // Start polling
        startPolling();
    </script>
}